#!/usr/bin/env node

/**
 * PROJECT STRUCTURE GENERATOR
 *
 * Generates a clean markdown file showing project structure
 * with proper tree formatting and configurable depth.
 */

import fs from 'fs/promises';
import fsSync from 'fs';
import path from 'path';

const CONFIG = {
    rootDir: path.join(process.cwd(), '..'),
    outputFile: 'docs/project-structure.md',
    maxDepth: 7,
    exclude: [
        'node_modules', 'dist', 'build', '.git', 'coverage',
        '.next', 'out', '__tests__', 'vendor', 'backup',
        '__pycache__', 'target', '.venv', 'venv', 'tmp', 'temp'
    ]
};

async function buildTree(dir, depth = 0, prefix = '') {
    if (depth > CONFIG.maxDepth) return [];

    const entries = [];

    try {
        const items = await fs.readdir(dir, { withFileTypes: true });

        // Sort: directories first, then files
        items.sort((a, b) => {
            if (a.isDirectory() && !b.isDirectory()) return -1;
            if (!a.isDirectory() && b.isDirectory()) return 1;
            return a.name.localeCompare(b.name);
        });

        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const itemPath = path.join(dir, item.name);
            const relativePath = path.relative(CONFIG.rootDir, itemPath);

            // Skip excluded and hidden items
            if (item.name.startsWith('.') || CONFIG.exclude.some(ex => relativePath.includes(ex))) {
                continue;
            }

            const isLast = i === items.length - 1;
            const connector = isLast ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
            const extension = isLast ? '    ' : '‚îÇ   ';

            if (item.isDirectory()) {
                entries.push(`${prefix}${connector}${item.name}/`);

                const subEntries = await buildTree(
                    itemPath,
                    depth + 1,
                    prefix + extension
                );
                entries.push(...subEntries);
            } else {
                entries.push(`${prefix}${connector}${item.name}`);
            }
        }
    } catch (error) {
        // Skip directories we can't read
    }

    return entries;
}

async function generateStructure() {
    console.log('üìÅ Generating project structure...');

    await fs.mkdir(path.dirname(CONFIG.outputFile), { recursive: true });

    const tree = await buildTree(CONFIG.rootDir);

    const report = [
        '# Project Structure',
        '',
        `**Generated:** ${new Date().toLocaleString()}`,
        `**Max Depth:** ${CONFIG.maxDepth} levels`,
        '',
        '```',
        '.',
        ...tree,
        '```',
        '',
        '## Excluded',
        '',
        'The following are excluded from this view:',
        '- Hidden files and directories (starting with `.`)',
        ...CONFIG.exclude.map(ex => `- \`${ex}\``),
        '',
        '---',
        '*Generated by Project Structure Generator*'
    ].join('\n');

    await fs.writeFile(CONFIG.outputFile, report, 'utf-8');

    console.log(`‚úÖ Structure saved to: ${CONFIG.outputFile}`);
    console.log(`üìä Max depth: ${CONFIG.maxDepth} levels`);
}

generateStructure().catch(error => {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
});
