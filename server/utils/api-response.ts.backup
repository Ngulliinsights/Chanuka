/**
 * API Response Utilities - Complete Implementation
 * Provides standardized response formats for all API endpoints
 */

import { Response } from 'express';

export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    message: string;
    code: string;
    statusCode: number;
    details?: any;
  };
  message?: string;
  timestamp: string;
  metadata?: {
    requestId?: string;
    duration?: number;
    source?: string;
    version?: string;
  };
}

export interface ErrorResponse {
  success: false;
  error: {
    message: string;
    code: string;
    statusCode: number;
    details?: any;
  };
  timestamp: string;
  metadata?: {
    requestId?: string;
    duration?: number;
    source?: string;
    version?: string;
  };
}

export interface ValidationError {
  field: string;
  message: string;
  code?: string;
  value?: any;
}

export interface PaginationMetadata {
  page: number;
  limit: number;
  total: number;
  totalPages: number;
  hasNext: boolean;
  hasPrev: boolean;
}

export interface ApiMetadata {
  requestId?: string;
  duration?: number;
  source?: string;
  version?: string;
  pagination?: PaginationMetadata;
}

export const UnifiedApiResponse = {
  success: <T>(data: T, message = 'Success', metadata?: ApiMetadata): ApiResponse<T> => ({
    success: true,
    data,
    message,
    timestamp: new Date().toISOString(),
    metadata
  }),

  error: (message: string, code = 'ERROR', statusCode = 500, metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code, statusCode },
    timestamp: new Date().toISOString(),
    metadata
  }),

  notFound: (message = 'Resource not found', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code: 'NOT_FOUND', statusCode: 404 },
    timestamp: new Date().toISOString(),
    metadata
  }),

  validation: (errors: ValidationError[], message = 'Validation failed', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: {
      message,
      code: 'VALIDATION_ERROR',
      statusCode: 400,
      details: errors
    },
    timestamp: new Date().toISOString(),
    metadata
  }),

  unauthorized: (message = 'Unauthorized access', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code: 'UNAUTHORIZED', statusCode: 401 },
    timestamp: new Date().toISOString(),
    metadata
  }),

  forbidden: (message = 'Access forbidden', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code: 'FORBIDDEN', statusCode: 403 },
    timestamp: new Date().toISOString(),
    metadata
  }),

  conflict: (message = 'Resource conflict', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code: 'CONFLICT', statusCode: 409 },
    timestamp: new Date().toISOString(),
    metadata
  }),

  rateLimit: (message = 'Rate limit exceeded', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code: 'RATE_LIMIT_EXCEEDED', statusCode: 429 },
    timestamp: new Date().toISOString(),
    metadata
  }),

  serverError: (message = 'Internal server error', metadata?: ApiMetadata): ErrorResponse => ({
    success: false,
    error: { message, code: 'INTERNAL_SERVER_ERROR', statusCode: 500 },
    timestamp: new Date().toISOString(),
    metadata
  })
};

// Express Response Helpers
export const ApiSuccess = <T>(res: Response, data: T, metadata?: ApiMetadata, statusCode = 200) => {
  return res.status(statusCode).json(UnifiedApiResponse.success(data, 'Success', metadata));
};

export const ApiError = (res: Response, message: string, statusCode = 500, metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.error(message, 'ERROR', statusCode, metadata);
  return res.status(statusCode).json(response);
};

export const ApiNotFound = (res: Response, message = 'Resource not found', metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.notFound(message, metadata);
  return res.status(404).json(response);
};

export const ApiValidationError = (res: Response, errors: ValidationError[] | ValidationError, metadata?: ApiMetadata) => {
  const errorArray = Array.isArray(errors) ? errors : [errors];
  const response = UnifiedApiResponse.validation(errorArray, 'Validation failed', metadata);
  return res.status(400).json(response);
};

export const ApiUnauthorized = (res: Response, message = 'Unauthorized access', metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.unauthorized(message, metadata);
  return res.status(401).json(response);
};

export const ApiForbidden = (res: Response, message = 'Access forbidden', metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.forbidden(message, metadata);
  return res.status(403).json(response);
};

export const ApiConflict = (res: Response, message = 'Resource conflict', metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.conflict(message, metadata);
  return res.status(409).json(response);
};

export const ApiRateLimit = (res: Response, message = 'Rate limit exceeded', metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.rateLimit(message, metadata);
  return res.status(429).json(response);
};

export const ApiServerError = (res: Response, message = 'Internal server error', metadata?: ApiMetadata) => {
  const response = UnifiedApiResponse.serverError(message, metadata);
  return res.status(500).json(response);
};

// Utility class for creating metadata
export class ApiResponseWrapper {
  static createMetadata(startTime: number, source: string, requestId?: string): ApiMetadata {
    return {
      requestId,
      duration: Date.now() - startTime,
      source,
      version: process.env.API_VERSION || '1.0.0'
    };
  }

  static createPaginationMetadata(page: number, limit: number, total: number): PaginationMetadata {
    const totalPages = Math.ceil(total / limit);
    return {
      page,
      limit,
      total,
      totalPages,
      hasNext: page < totalPages,
      hasPrev: page > 1
    };
  }

  static success<T>(data: T, message?: string, metadata?: ApiMetadata): ApiResponse<T> {
    return UnifiedApiResponse.success(data, message, metadata);
  }

  static error(message: string, code?: string, statusCode?: number, metadata?: ApiMetadata): ErrorResponse {
    return UnifiedApiResponse.error(message, code, statusCode, metadata);
  }
}

// Legacy exports for backward compatibility
// Note: ApiResponseWrapper class is defined above, so we don't re-export here

// Type guards
export const isApiResponse = (obj: any): obj is ApiResponse => {
  return obj && typeof obj === 'object' && typeof obj.success === 'boolean' && obj.timestamp;
};

export const isErrorResponse = (obj: any): obj is ErrorResponse => {
  return isApiResponse(obj) && obj.success === false && !!obj.error;
};

// Common error codes
export const ERROR_CODES = {
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  NOT_FOUND: 'NOT_FOUND',
  UNAUTHORIZED: 'UNAUTHORIZED',
  FORBIDDEN: 'FORBIDDEN',
  CONFLICT: 'CONFLICT',
  RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED',
  INTERNAL_SERVER_ERROR: 'INTERNAL_SERVER_ERROR',
  BAD_REQUEST: 'BAD_REQUEST',
  SERVICE_UNAVAILABLE: 'SERVICE_UNAVAILABLE',
  TIMEOUT: 'TIMEOUT'
} as const;

export type ErrorCode = typeof ERROR_CODES[keyof typeof ERROR_CODES];
