name: Graph Module - Type Check, Lint, and Test

on:
  push:
    branches: [main, develop]
    paths:
      - 'shared/database/graph/**'
      - 'shared/core/**'
      - 'package.json'
      - 'tsconfig.json'

  pull_request:
    branches: [main, develop]
    paths:
      - 'shared/database/graph/**'
      - 'shared/core/**'

jobs:
  type-check:
    runs-on: ubuntu-latest
    name: TypeScript Type Check

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Report type errors
        if: failure()
        run: |
          echo "‚ùå Type check failed. Fix errors above."
          exit 1

  lint:
    runs-on: ubuntu-latest
    name: ESLint

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npx eslint shared/database/graph --ext .ts --format=compact

  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- shared/database/graph --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: graph-module
          fail_ci_if_error: false

  integration-tests:
    runs-on: ubuntu-latest
    name: Integration Tests

    services:
      neo4j:
        image: neo4j:5.0
        env:
          NEO4J_AUTH: neo4j/testpass
          NEO4J_ACCEPT_LICENSE_AGREEMENT: 'yes'
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpass 'RETURN 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 7687:7687

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Wait for Neo4j
        run: |
          for i in {1..30}; do
            npx cypher-shell -a bolt://localhost:7687 -u neo4j -p testpass "RETURN 1" && exit 0
            sleep 2
          done
          echo "‚ùå Neo4j did not start"
          exit 1

      - name: Run integration tests
        env:
          NEO4J_TEST_URI: bolt://localhost:7687
          NEO4J_TEST_USER: neo4j
          NEO4J_TEST_PASSWORD: testpass
        run: npm run test:integration -- --run shared/database/graph

  smoke-tests:
    runs-on: ubuntu-latest
    name: Smoke Tests (GraphQL API)
    needs: [unit-tests, integration-tests]

    services:
      neo4j:
        image: neo4j:5.0
        env:
          NEO4J_AUTH: neo4j/testpass
          NEO4J_ACCEPT_LICENSE_AGREEMENT: 'yes'
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpass 'RETURN 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        ports:
          - 7687:7687

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Start API server (background)
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: testpass
          PORT: 3000
        run: npm start &
        timeout-minutes: 2

      - name: Wait for server
        run: |
          for i in {1..20}; do
            curl -s http://localhost:3000/health/liveness && exit 0
            sleep 1
          done
          echo "‚ùå Server did not start"
          exit 1

      - name: Smoke test: liveness
        run: |
          curl -f http://localhost:3000/health/liveness || exit 1

      - name: Smoke test: readiness
        run: |
          curl -f http://localhost:3000/health/readiness || exit 1

      - name: Smoke test: GraphQL query
        run: |
          curl -X POST http://localhost:3000/graphql \
            -H "Content-Type: application/json" \
            -d '{"query": "{ __typename }"}' || exit 1

  benchmark:
    runs-on: ubuntu-latest
    name: Performance Benchmark (Optional)
    if: github.event_name == 'pull_request'
    continue-on-error: true

    services:
      neo4j:
        image: neo4j:5.0
        env:
          NEO4J_AUTH: neo4j/testpass
          NEO4J_ACCEPT_LICENSE_AGREEMENT: 'yes'
        ports:
          - 7687:7687

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        env:
          NEO4J_TEST_URI: bolt://localhost:7687
          NEO4J_TEST_USER: neo4j
          NEO4J_TEST_PASSWORD: testpass
        run: npm run test:perf -- shared/database/graph --reporter=verbose

      - name: Comment benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('./perf-results.json', 'utf8'));
            const comment = `## üìä Performance Benchmark\n\n${JSON.stringify(results, null, 2)}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  summary:
    runs-on: ubuntu-latest
    name: Summary
    needs: [type-check, lint, unit-tests, integration-tests, smoke-tests]
    if: always()

    steps:
      - name: Check status
        run: |
          if [ "${{ needs.type-check.result }}" != "success" ]; then
            echo "‚ùå Type check failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "‚ùå Lint check failed"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "‚ùå Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "‚ùå Integration tests failed"
            exit 1
          fi
          if [ "${{ needs.smoke-tests.result }}" != "success" ]; then
            echo "‚ùå Smoke tests failed"
            exit 1
          fi
          echo "‚úÖ All checks passed!"
