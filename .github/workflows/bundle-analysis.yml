name: Bundle Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  bundle-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build and analyze bundle
      run: npm run analyze:bundle:ci:strict
      env:
        CI: true
        BUNDLE_FAIL_SCORE: 75
        BUNDLE_FAIL_SIZE: 3.0
        BUNDLE_VERBOSE: true

    - name: Enforce performance budgets
      run: node scripts/performance-budget-enforcer.cjs
      env:
        CI: true
        BUDGET_FAIL_ON_VIOLATION: true
        BUDGET_FAIL_SCORE: 75
        BUDGET_FAIL_SIZE: 3.0
        BUDGET_VERBOSE: true

    - name: Upload performance reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-reports
        path: |
          bundle-reports/
          bundle-analysis.json
          bundle-analysis.md
          performance-budget-report.json
          performance-budget-report.md
          performance-data/
          performance-reports/
        retention-days: 30

    - name: Comment PR with bundle analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Read the markdown report
          const reportPath = path.join(process.cwd(), 'bundle-analysis.md');
          if (!fs.existsSync(reportPath)) {
            console.log('Bundle analysis report not found');
            return;
          }

          const report = fs.readFileSync(reportPath, 'utf8');

          // Post comment on PR
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ“¦ Bundle Analysis Report

${report}

[View detailed HTML report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          });

  bundle-baseline-update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Update bundle baseline
      run: npm run analyze:bundle:save-baseline

    - name: Commit baseline update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add bundle-baseline.json
        git commit -m "chore: update bundle analysis baseline" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}