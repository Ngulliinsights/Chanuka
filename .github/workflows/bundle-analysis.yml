name: Bundle Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  bundle-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build and analyze bundle
      run: npm run analyze:bundle:ci:strict
      env:
        CI: true
        BUNDLE_FAIL_SCORE: 75
        BUNDLE_FAIL_SIZE: 3.0
        BUNDLE_VERBOSE: true

    - name: Analyze Radix UI bundle sizes
      run: npm run analyze:radix
      env:
        CI: true

    - name: Enforce performance budgets
      run: node scripts/performance-budget-enforcer.cjs
      env:
        CI: true
        BUDGET_FAIL_ON_VIOLATION: true
        BUDGET_FAIL_SCORE: 75
        BUDGET_FAIL_SIZE: 3.0
        BUDGET_VERBOSE: true

    - name: Run Core Web Vitals checks
      run: node scripts/web-vitals-checker.js
      env:
        CI: true
        VITALS_FAIL_ON_VIOLATION: true
        VITALS_LCP_THRESHOLD: 2500
        VITALS_FID_THRESHOLD: 100
        VITALS_CLS_THRESHOLD: 0.1
        VITALS_FCP_THRESHOLD: 1800
        VITALS_TTFB_THRESHOLD: 800

    - name: Check for performance regressions
      run: node scripts/performance-regression-detector.js
      env:
        CI: true

    - name: Run Design System Audit
      run: npm run audit:design-system
      env:
        CI: true

    - name: Upload performance reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-reports
        path: |
          bundle-reports/
          bundle-analysis.json
          bundle-analysis.md
          performance-budget-report.json
          performance-budget-report.md
          web-vitals-report.json
          web-vitals-report.md
          performance-regression-report.json
          performance-regression-report.md
          performance-data/
          performance-reports/
          reports/radix-analysis/
          reports/radix-bundle-analysis.json
          reports/radix-bundle-analysis.md
          reports/design-system-audit-report.json
          reports/design-system-audit-report.md
        retention-days: 30

    - name: Comment PR with bundle analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          let body = '## üì¶ Bundle Analysis Report\n\n';

          // Read the main bundle analysis report
          const bundleReportPath = path.join(process.cwd(), 'bundle-analysis.md');
          if (fs.existsSync(bundleReportPath)) {
            const bundleReport = fs.readFileSync(bundleReportPath, 'utf8');
            body += bundleReport + '\n\n---\n\n';
          }

          // Read the Radix analysis report
          const radixReportPath = path.join(process.cwd(), 'reports/radix-bundle-analysis.md');
          if (fs.existsSync(radixReportPath)) {
            const radixReport = fs.readFileSync(radixReportPath, 'utf8');
            body += '## üîç Radix UI Bundle Analysis\n\n' + radixReport + '\n\n---\n\n';
          }

          // Read the Design System audit report
          const designSystemReportPath = path.join(process.cwd(), 'reports/design-system-audit-report.md');
          if (fs.existsSync(designSystemReportPath)) {
            const designSystemReport = fs.readFileSync(designSystemReportPath, 'utf8');
            body += '## üé® Design System Audit\n\n' + designSystemReport + '\n\n---\n\n';
          }

          body += `[View detailed reports](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

          // Post comment on PR
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  bundle-baseline-update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Update bundle baseline
      run: npm run analyze:bundle:save-baseline

    - name: Commit baseline update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add bundle-baseline.json
        git commit -m "chore: update bundle analysis baseline" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}